# SuiteSparse can be installed from apt, but is much slower than expected. This
# is probably because it is linked against BLAS instead of OpenBLAS. OpenBLAS
# is a high-performance, open-source implementation of the BLAS (Basic Linear
# Algebra Subprograms) standard, while BLAS is the general specification or a
# reference implementation. OpenBLAS is generally faster than the reference
# BLAS because it includes optimizations for modern hardware, portability
# across different architectures, and dynamic CPU detection.

# Old SuiteSparse installations installed from apt can be removed with:
sudo apt remove --purge libsuitesparse-dev
sudo rm -rf /usr/include/suitesparse
sudo rm -rf /usr/lib/*/libsuitesparse*

# Instead, build everything from souce, beginning with OpenBLAS:
git clone https://github.com/xianyi/OpenBLAS.git
cd OpenBLAS
# DYNAMIC_ARCH=1 enables runtime CPU detection, ensuring portability across Intel, AMD, and ARM hardware
make DYNAMIC_ARCH=1 HOSTCC=gcc -j$(nproc)
sudo make PREFIX=/opt/OpenBLAS install

# Apt doesn't have the latest CMake, which is required to build SuiteSparse, so
# build CMake from source first:
wget https://github.com/Kitware/CMake/releases/download/v3.27.5/cmake-3.27.5.tar.gz
tar -xzf cmake-3.27.5.tar.gz
cd cmake-3.27.5
./bootstrap
make -j$(nproc)
sudo make install

# SuiteSparse pre-requisites can, thank goodness, be installed from apt:
sudo apt install libgmp-dev
sudo apt install libmpfr-dev

# Now SuiteSparse can be compiled from source:
git clone https://github.com/DrTimothyAldenDavis/SuiteSparse.git
cd SuiteSparse
mkdir -p build && cd build
# These CMake flags will set CUDA as enabled:
cmake -DBLA_VENDOR=OpenBLAS \
      -DBLAS_LIBRARIES=/opt/OpenBLAS/lib/libopenblas.a \
      -DLAPACK_LIBRARIES=/opt/OpenBLAS/lib/libopenblas.a \
      -DCMAKE_PREFIX_PATH=/opt/OpenBLAS \
      -DCMAKE_INSTALL_PREFIX=/opt/SuiteSparse ..
# Now build and install with:	  
cmake --build .
sudo cmake --install .


